/*!
 * knockout-router v0.2.0 http://alexbihary.github.com/knockout-router
 * Copyright 2014 Alexander Bihary
 * Licensed under MIT (https://github.com/alexbihary/knockout-router/blob/master/LICENSE)
 */
!function(a){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?a(require("knockout"),exports):"function"==typeof define&&define.amd?define(["knockout","exports"],a):a(ko,ko.history={})}(function(a,b){var c=/^[#\/]|\s+$/g,d=/^\/+|\/+$/g,e=/\/$/,f=/#.*$/,g={location:window.location,history:window.history,interval:50,historyStarted:!1,options:{root:"/"},root:"/",wantsHashChange:!1,hasHashChange:!1,wantsPushState:!1,hasPushState:!1,handlers:[]};b.getEnv=function(){return a.utils.extend({},g)},b.atRoot=function(){return g.location.pathname.replace(/[^\/]$/,"$&/")===g.root},b.getHash=function(a){var b=(a||g).location.href.match(/#(.*)$/);return b?b[1]:""},b.getFragment=function(a,d){if(null==a)if(g.hasPushState||!g.wantsHashChange||d){a=decodeURI(g.location.pathname+g.location.search);var f=g.root.replace(e,"");a.indexOf(f)||(a=a.slice(f.length))}else a=b.getHash();return a.replace(c,"")},b.start=function(e){if(g.historyStarted)throw new Error("knockout-history has already been started");g.historyStarted=!0,a.utils.extend(g.options,e),g.root=g.options.root,g.wantsHashChange=g.options.hashChange!==!1,g.hasHashChange="onhashchange"in window,g.wantsPushState=!!g.options.pushState,g.hasPushState=!!(g.options.pushState&&g.history&&g.history.pushState);var f=b.getFragment(),h=window.addEventListener||function(a,b){return attachEvent("on"+a,b)};if(g.root=("/"+g.root+"/").replace(d,"/"),!(g.hasHashChange||!g.wantsHashChange||g.wantsPushState&&g.hasPushState)){var i=document.createElement("iframe");i.src="javascript:0",i.style.display="none",i.tabIndex=-1;var j=document.body;g.iframe=j.insertBefore(i,j.firstChild).contentWindow,b.navigate(f)}if(g.hasPushState?h("popstate",b.checkUrl,!1):g.wantsHashChange&&g.hasHashChange&&!g.iframe?h("hashchange",b.checkUrl,!1):g.wantsHashChange&&(b._checkUrlInterval=setInterval(b.checkUrl,g.interval)),g.fragment=f,g.wantsHashChange&&g.wantsPushState){if(!g.hasPushState&&!b.atRoot())return g.fragment=b.getFragment(null,!0),g.location.replace(g.root+"#"+g.fragment),!0;g.hasPushState&&b.atRoot()&&g.location.hash&&(g.fragment=b.getHash().replace(c,""),g.history.replaceState({},document.title,g.root+g.fragment))}return g.options.silent?void 0:b.loadUrl()},b.stop=function(){var a=window.removeEventListener||function(a,b){return detachEvent("on"+a,b)};g.hasPushState?a("popstate",b.checkUrl,!1):g.wantsHashChange&&g.hasHashChange&&g.iframe&&a("hashchange",b.checkUrl,!1),b._checkUrlInterval&&clearInterval(b._checkUrlInterval),g.historyStarted=!1},b.route=function(a,b,c,d){g.handlers[d?"push":"unshift"]({route:a,callback:b,name:c})},b.checkUrl=function(){var a=b.getFragment();return a===g.fragment&&g.iframe&&(a=b.getFragment(b.getHash(g.iframe))),a===g.fragment?!1:(g.iframe&&b.navigate(a),void b.loadUrl())},b.loadUrl=function(c){return c=g.fragment=b.getFragment(c),a.utils.arrayFirst(g.handlers,function(a){return a.route.test(c)?(a.callback(c),!0):void 0})},b.navigate=function(a,c){if(!g.historyStarted)return!1;c&&c!==!0||(c={trigger:!!c});var d=g.root+(a=b.getFragment(a||""));if(a=a.replace(f,""),g.fragment!==a){if(g.fragment=a,""===a&&"/"!==d&&(d=d.slice(0,-1)),g.hasPushState)g.history[c.replace?"replaceState":"pushState"]({},document.title,d);else{if(!g.wantsHashChange)return g.location.assign(d);b.updateHash(g.location,a,c.replace),g.iframe&&a!==b.getFragment(b.getHash(g.iframe))&&(c.replace||g.iframe.document.open().close(),b.updateHash(g.iframe.location,a,c.replace))}return c.trigger?b.loadUrl(a):void 0}},b.updateHash=function(a,b,c){if(c){var d=a.href.replace(/(javascript:|#).*$/,"");a.replace(d+"#"+b)}else a.hash="#"+b},a.history=b}),function(a){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?a(require("knockout"),exports):"function"==typeof define&&define.amd?define(["knockout","exports"],a):a(ko,ko.router={})}(function(a,b){function c(b,c){"string"==typeof b&&(b={route:b}),this.config=b,this.element=c,this.isActive=a.observable(!1),e(this.config)}function d(a,b){for(var c,d,e={},f=0;null!==(c=y.exec(b));)d=c[1],A.test(d)&&a[f]&&(e[d]=a[f]),f++;if(a[f]&&z.test(a[f])){var g=a[f].split("&");g.forEach(function(a){var b=a.split("=");b[1]&&(e[b[0]]=b[1])})}return e}function e(a){a.title=a.title||f(a.route),a.module=a.module,a.hash=a.hash||g(a.route),a.href=a.href||h(a.route),a.name=a.name||i(a.route),a.routePattern=m(a.route),a.callback=k(a.callback,"function")&&a.callback||r}function f(a){var b=j(a);return b.substring(0,1).toUpperCase()+b.substring(1)}function g(a){return 0===a.indexOf(s().hashPrefix)?a:s().hashPrefix+a}function h(a){return s().root+a}function i(a){var b=j(a);return b.replace(/\//g,"-")}function j(a){var b=a.indexOf(":"),c=b>0?b-1:a.length;return a.substring(0,c)}function k(a,b){if("undefined"==typeof a)return"undefined"===b.toLowerCase();var c=new RegExp("\\[object "+b+"\\]","i");return c.test(Object.prototype.toString.call(a))}function l(){p.push(new c(t)),a.utils.arrayForEach(p(),function(c){a.history.route(c.config.routePattern,function(a){var d=n(c.config.routePattern,a);c.activate(d,a),b.vm.activeRoute(c),c.config.callback&&c.config.callback.apply(c,d),s().notify&&s().notify.apply(c,d),s().debug&&(console.group("knockout-router: navigated"),console.debug('route: "%s" (%s)',c.config.route,c.config.name),console.debug('fragment: "%s"',a),console.debug("args: ",d),console.debug("instance: %O",c),console.groupEnd())},c.config.name,!0)})}function m(a){return a=a.replace(x,"\\$&").replace(u,"(?:$1)?").replace(v,function(a,b){return b?a:"([^/?]+)"}).replace(w,"([^?]*?)"),new RegExp("^"+a+"(?:\\?([\\s\\S]*))?$")}function n(b,c){var d=b.exec(c).slice(1);return a.utils.arrayMap(d,function(a,b){return b===d.length-1?a||null:a?decodeURIComponent(a):null})}function o(){B(document,"click",function(a){var c=a.target||a.srcElement;if(c&&"A"===c.nodeName&&!c.getAttribute("data-bypass")){var d=c.getAttribute("href"),e=c.protocol+"//";d&&d.slice(0,e.length)!==e&&0!==d.indexOf("javascript:")&&(a.preventDefault(),b.navigate(d,!0))}},!1)}var p=a.observableArray([]),q=a.observableArray([]),r=function(){},s=a.observable({debug:!1,handleRelativeAnchors:!0,hashPrefix:"#",notify:r,root:"/"}),t={route:"*notfound",name:"notfound",callback:r,nav:!1},u=/\((.*?)\)/g,v=/(\(\?)?:\w+/g,w=/\*\w+/g,x=/[\-{}\[\]+?.,\\\^$|#\s]/g,y=/:(\w+)/g,z=/^([a-zA-Z_$][0-9a-zA-Z_$]*=[^&]*&?)+$/,A=/^[a-zA-Z_$][0-9a-zA-Z_$]*$/;console.debug||(console.debug=console.log),console.group||(console.group=console.groupEnd=console.log),c.prototype.activate=function(b,c){return this.element&&(this.element.style.display=""),this.subscribers&&a.utils.arrayForEach(this.subscribers(),function(a){a.element.style.display=""}),this.isActive(!0),this.args=b,this.data=d(b,this.config.route),this.fragment=c,this},c.prototype.deactivate=function(){return this.element&&(this.element.style.display="none"),this.subscribers&&a.utils.arrayForEach(this.subscribers(),function(a){a.element.style.display="none"}),this.isActive(!1),this},c.prototype.subscribe=function(b,c){this.subscribers=this.subscribers||a.observableArray([]),this.subscribers.push({config:b,element:c})};var B=function(){var a=function(a,b,c){for(var d=0,e=a.length;e>d;d++)B(a[d],b,c)};return document.addEventListener?function(b,c,d){b&&b.nodeName||b===window?b.addEventListener(c,d,!1):b&&b.length&&a(b,c,d)}:function(b,c,d){b&&b.nodeName||b===window?b.attachEvent("on"+c,function(){return d.call(b,window.event)}):b&&b.length&&a(b,c,d)}}();b.configure=function(c){return a.utils.extend(s(),c||{}),b},b.init=function(c){return l(),s().debug&&(console.group("knockout-router: started"),console.debug("settings: %O",s()),console.debug("debug mode: enabled"),console.groupEnd(),window.ko=window.ko||a,window.vm=window.vm||b.vm),a.history.start(a.utils.extend(s(),c||{})),s().handleRelativeAnchors&&o(),b},b.vm={settings:s,navRoutes:a.computed(function(){return a.utils.arrayFilter(p(),function(a){return a.config.nav})}),routes:p,activeRoute:a.observable(),isNavigating:a.observable(!1)},b.vm.activeRoute.subscribe(function(b){b&&(a.utils.arrayForEach(q(),function(a){a&&a!==b&&q.remove(a.deactivate())}),q.push(b))}),b.map=function(a){return k(a,"array")&&a.forEach(function(a){p.push(new c(a))}),b},b.mapNotFound=function(c){return a.utils.extend(t,c||{}),b},b.navigate=function(c,d){return a.history.navigate(c,d),b},a.bindingHandlers.router={init:function(){return{controlsDescendantBindings:!0}},update:function(c,d){var e,f,g,h,i=d();a.computed(function(){f=a.utils.unwrapObservable(i),g={},h={},e=b.vm.activeRoute(),e&&(e.config.module?(g.name=e.config.module,g.template=e.config.template||e.config.module,g.data=e.args,a.applyBindingsToNode(c,{module:g})):e.config.template&&(h.name=e.config.template,h.data=e.data,a.applyBindingsToNode(c,{template:h})))})}},a.bindingHandlers.route={init:function(b,d){var e,f,g=a.utils.unwrapObservable(d());k(g,"string")&&(g={route:g}),f=g.route||g.name,e=a.utils.arrayFirst(p(),function(a){return a.config.name===f||a.config.route===f||a.config.routePattern===m(f)}),e?e.subscribe(g,b):p.push(new c(g,b))}},a.virtualElements&&(a.virtualElements.allowedBindings.router=!0,a.virtualElements.allowedBindings.route=!0),a.router=b});